<!DOCTYPE html>
<html>
  <style>
    :root {
      --blue: #667eea;
      --red: #ea6666;
      --lightblue: #9aa8e6;
      --green: #66ea92;
      --pink: #ea6690;
      --orange: #667eea;
      --grey: #898989;
      --white:  #ffffff;
    }
    .header{
        font-family: "Verdana", sans-serif;
    }

    .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-width: 1200px;
            margin: 0 auto;
            font-family: "Verdana", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    .axis {
        color: var(--grey);
    }
    .content {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        font-family: "Verdana", sans-serif;
 
    }
    .slide-title {
        font-size: 1.8rem;
        margin: 0 0 8px 0;
        font-weight: 300;
        color: #000000;
    }
    .slide-description {
        color: #000000;
    }
    .insight-box {
        background: linear-gradient(145deg, var(--blue), var(--lightblue));
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        font-family: "Verdana", sans-serif;
    }
    .slide {
        display: none;
    }
    .slide.active {
        display: block;
    }
    .controls {
        position: fixed;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: #f8f9fa;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        width: 60px;
    }
    .nav-button {
        background: #fff;
        border: 2px solid #dee2e6;
        color: #495057;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    .nav-button:hover {
        background: #f8f9fa;
        border-color: var(--blue);
        color: var(--blue);
        transform: translateY(-1px);
    }
    .nav-button.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
        transform: translateY(-1px);
    }
    .legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #2c3e50;
    }
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 50%;
    }
    
    </style>
  
    <!-- Title, header, and description of project -->
    <title>Narrative Visualization Project</title>
    <div class="header">
        <h1 style="text-align: center;">2017 Car Fuel Efficiency Analysis</h1>
        <p style="text-align: center;">
            Exploring fuel types, engine sizes, and manufacturer fuel performance in 2017
        </p>
    </div>

    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Load d3-annotation -->
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

    <body onload='loadData()'>
        <div class="content">

            <!-- Slide 1: Fuel Type Overview -->
            <div class="slide active" id="slide1">
                <h2 class="slide-title">Chapter 1: The Fuel Revolution</h2>
                <p class="slide-description">
                    While gasoline is still the most prevalent car fuel type, electric vehicles (EVs) are making their mark with exceptional efficiency ratings. Let's explore how different fuel types perform.
                </p>
                
                <!-- Chart 1 -->
                <div class="chart-container">
                    <svg id="chart1"></svg>
                </div>

                <!-- Legend for Chart 1 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--red);"></div>
                        <span>City MPG</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--blue);"></div>
                        <span>Highway MPG</span>
                    </div>
                </div>

                <!-- Key Insight for Chart 1 -->
                <div class="insight-box">
                    <h3>Key Insight</h3>
                    <p>Electric vehicles are significantly more efficient than gas or diesel cars especially for city driving. Stop-and-go traffic plays to the strengths of these vehicles, making them an appealing choice for people living in urban areas. </p>
                </div>
            </div>

            <!-- Slide 2: Engine Cylinders vs Efficiency -->
            <div class="slide" id="slide2">
                <h2 class="slide-title">Chapter 2: The Cylinder Paradox</h2>
                <p class="slide-description">
                    More cylinders typically mean more power, but there's a noticeable trade-off with fuel efficiency. This scatter plot reveals the relationship between cylinder number and fuel economy.
                </p>

                <!-- Chart 2 -->
                <div class="chart-container">
                      <svg id="chart2"></svg>
                </div>

                <!-- Legend for Chart 2 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--red);"></div>
                        <span>City MPG</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--blue);"></div>
                        <span>Highway MPG</span>
                    </div>
                </div>

                <!-- Key Insight for Chart 2 -->
                <div class="insight-box">
                    <h3>Key Insight</h3>
                    <p>There's a clear inverse relationship between number of engine cylinders and MPG. 0-cylinder electric vehicles stand high above the other engine options in fuel efficiency, while 12-cylinder luxury engines prioritize performance over economy.</p>
                </div>
            </div>

            <!-- Slide 3: Top Manufacturers -->
            <div class="slide" id="slide3">
                <h2 class="slide-title">Chapter 3: Brand Performance Leaders</h2>
                <p class="slide-description">
                    Which manufacturers are leading the efficiency race? This ranking shows average combined (city & highway) MPG across all models for each brand.
                </p>

                <!-- Chart 3 -->
                <div class="chart-container">
                    <svg id="chart3"></svg>
                </div>

                <!-- Legend for Chart 3 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--green);"></div>
                        <span>Electric</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--blue);"></div>
                        <span>Gasoline</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--pink);"></div>
                        <span>Mixed</span>
                    </div>
                </div>

                <!-- Key Insight for Chart 3 -->
                <div class="insight-box">
                    <h3>Key Insight</h3>
                    <p>The calculated scaled average of brands indicates fuel efficiency across all brand models. The higher the scaled average, the more efficient a brand is across all of their models and the higher the ranking. Here, we see the top 9 brands all make electric vehicles, once again highlighting the overwhelming efficiency of EVs</p>
                </div>
            </div>

            <!-- Slide Controls -->
            <div class="controls">
                <button class="nav-button active" slide="0">1</button>
                <button class="nav-button" slide="1">2</button>
                <button class="nav-button" slide="2">3</button>
            </div>
    
        </div>

        <!-- Chart tooltip -->
        <div class="tooltip" id="tooltip"></div>

        <!-- D3 script -->
        <script>
            // Declare global variables
            let data = [];
            let currentSlide = 0; // Start with chart 1
            const totalSlides = 3; // There are 3 charts total
            const rootStyles = getComputedStyle(document.documentElement);

            // Load data from external CSV
            async function loadData() {
                console.log('Loading data from CSV...');
                try {
                    const rawData = await d3.csv("https://flunky.github.io/cars2017.csv");
                    console.log('Raw data loaded:', rawData.length, 'rows');
                    // Parse and transform the data
                    data = rawData.map(d => ({
                        make: d.Make,
                        fuel: d.Fuel,
                        cylinders: +d.EngineCylinders,
                        highwayMPG: +d.AverageHighwayMPG,
                        cityMPG: +d.AverageCityMPG,
                        combinedMPG: (+d.AverageHighwayMPG + +d.AverageCityMPG) / 2
                    }));
                    console.log('Data processed:', data.length, 'rows');

                    // Create the charts now that data has loaded
                    createChart1();
                    createChart2();
                    createChart3();
                    setupEventListeners();
                } catch (error) {
                    console.error('Error loading data:', error);
                    return
                }
            }

            // Slide controls
            function setupEventListeners() {
                document.querySelectorAll('.nav-button').forEach((button, index) => {
                    button.addEventListener('click', () => {
                        goToSlide(index);
                    });
                });
            }

            // Handles slide transition
            function goToSlide(slideIndex) {
                if (slideIndex < 0 || slideIndex >= totalSlides) return;
                
                // Hide current slide
                document.querySelectorAll('.slide').forEach(slide => {
                    slide.classList.remove('active');
                });
                
                // Show new slide
                document.querySelectorAll('.slide')[slideIndex].classList.add('active');
                
                // Update navigation buttons
                document.querySelectorAll('.nav-button').forEach((button, index) => {
                    button.classList.toggle('active', index === slideIndex);
                });
                
                currentSlide = slideIndex;
              
            }

            // Chart 1: Fuel Type Comparison
            function createChart1() {
                // Grouping data by fuel type
                const fuelData = d3.group(data, d => d.fuel);

                // Creating new data array form grouped metrics
                const fuelStats = Array.from(fuelData, ([fuel, cars]) => ({
                    fuel: fuel,
                    avgHighway: d3.mean(cars, d => d.highwayMPG),
                    avgCity: d3.mean(cars, d => d.cityMPG),
                    count: cars.length,

                    // Additional useful stats
                    minCity: d3.min(cars, d => d.cityMPG),
                    maxCity: d3.max(cars, d => d.cityMPG),
                    minHighway: d3.min(cars, d => d.highwayMPG),
                    maxHighway: d3.max(cars, d => d.highwayMPG)
                }));

                // Sort by average of city and highway MPG
                fuelStats.sort((a, b) => ((b.avgCity + b.avgHighway) / 2) - ((a.avgCity + a.avgHighway) / 2));

                // Chart dimensions
                const margin = { top: 20, right: 30, bottom: 80, left: 70 };
                const width = 900 - margin.left - margin.right;
                const height = 500 - margin.bottom - margin.top;

                // Create SVG
                const svg = d3.select('#chart1')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);
                
                // Scales
                const x0Scale = d3.scaleBand() // Scale for fuel type
                    .domain(fuelStats.map(d => d.fuel))
                    .range([0, width])
                    .padding(0.2);
                const x1Scale = d3.scaleBand() // Scale for mpg type
                    .domain(['city', 'highway'])
                    .range([0, x0Scale.bandwidth()])
                    .padding(0.05);
                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(fuelStats, d => Math.max(d.avgCity, d.avgHighway)) * 1.1])
                    .range([height, 0]);
                
                // Create tooltip
                const tooltip = d3.select("#tooltip");
                
                // Add tick marks
                g.selectAll('.tick-marks')
                    .data(yScale.ticks(8))
                    .enter()
                    .append('line')
                    .attr('class', 'tick-marks')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('y1', d => yScale(d))
                    .attr('y2', d => yScale(d));

                // Create fuel type groups
                const fuelGroups = g.selectAll('.fuel-group')
                    .data(fuelStats)
                    .enter()
                    .append('g')
                    .attr('class', 'fuel-group')
                    .attr('transform', d => `translate(${x0Scale(d.fuel)}, 0)`);
                
                // Add city MPG bars
                fuelGroups.selectAll('.city-bar')
                    .data(d => [d])
                    .enter()
                    .append('rect')
                    .attr('class', 'bar city-bar')
                    .attr('x', x1Scale('city'))
                    .attr('width', x1Scale.bandwidth())
                    .attr('y', height)
                    .attr('height', 0)
                    .attr('rx', 3)
                    .attr('ry', 3)
                    .attr("fill", rootStyles.getPropertyValue('--red'))
                    .on('mouseover', function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', 1);
                        tooltip.html(`
                            <strong>${d.fuel} - City MPG</strong><br/>
                            Average: <strong>${d.avgCity.toFixed(1)}</strong><br/>
                            Range: ${d.minCity.toFixed(1)} - ${d.maxCity.toFixed(1)}<br/>
                            Records: ${d.count}
                        `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.transition()
                            .duration(500)
                            .style('opacity', 0);
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100)
                    .attr('y', d => yScale(d.avgCity))
                    .attr('height', d => height - yScale(d.avgCity));
                
                // Add highway MPG bars
                fuelGroups.selectAll('.highway-bar')
                    .data(d => [d])
                    .enter()
                    .append('rect')
                    .attr('class', 'bar highway-bar')
                    .attr('x', x1Scale('highway'))
                    .attr('width', x1Scale.bandwidth())
                    .attr('y', height)
                    .attr('height', 0)
                    .attr('rx', 3)
                    .attr('ry', 3)
                    .attr("fill", rootStyles.getPropertyValue('--blue'))
                    .on('mouseover', function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', 1);
                        tooltip.html(`
                            <strong>${d.fuel} - Highway MPG</strong><br/>
                            Average: <strong>${d.avgHighway.toFixed(1)}</strong><br/>
                            Range: ${d.minHighway.toFixed(1)} - ${d.maxHighway.toFixed(1)}<br/>
                            Records: ${d.count}
                        `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.transition()
                            .duration(500)
                            .style('opacity', 0);
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100 + 50)
                    .attr('y', d => yScale(d.avgHighway))
                    .attr('height', d => height - yScale(d.avgHighway));
                
                // Add value labels on city bars
                fuelGroups.selectAll('.city-label')
                    .data(d => [d])
                    .enter()
                    .append('text')
                    .attr('class', 'bar-label city-label')
                    .attr('x', x1Scale('city') + x1Scale.bandwidth() / 2)
                    .attr('y', d => yScale(d.avgCity) - 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', rootStyles.getPropertyValue('--grey'))
                    .style('font-size', 12)
                    .style('opacity', 0)
                    .text(d => d.avgCity.toFixed(1))
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100 + 500)
                    .style('opacity', 1);
                
                // Add value labels on highway bars
                fuelGroups.selectAll('.highway-label')
                    .data(d => [d])
                    .enter()
                    .append('text')
                    .attr('class', 'bar-label highway-label')
                    .attr('x', x1Scale('highway') + x1Scale.bandwidth() / 2)
                    .attr('y', d => yScale(d.avgHighway) - 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', rootStyles.getPropertyValue('--grey'))
                    .style('font-size', 12)
                    .style('opacity', 0)
                    .text(d => d.avgHighway.toFixed(1))
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100 + 500)
                    .style('opacity', 1);
                
                // Add axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x0Scale))
                    .selectAll('text')
                    .style('font-size', '12px')
                    .style('font-weight', '500')
                    .attr('transform', 'rotate(-15)')
                    .style('text-anchor', 'end');
                
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale));
                
                // Add axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .style('fill', rootStyles.getPropertyValue('--grey'))
                    .text('Average Miles Per Gallon (MPG)');
                
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .style('fill', rootStyles.getPropertyValue('--grey'))
                    .text('Fuel Type');

                // Create annotation
                const annotations = [
                    {
                        note: {
                            label: "Note: unlike diesel and gasoline, electric cars are more efficient on city roads"
                        },
                        x: 180,
                        y: 60,
                        dx: 200,
                        dy: 40
                    }
                ]

                const makeAnnotations = d3.annotation()
                    .type(d3.annotationLabel)
                    .annotations(annotations);

                // Add annotation group to the chart with initial hidden state
                const annotationGroup = d3.select("#chart1")
                    .append("g")
                    .attr("class", "annotation-group")
                    .style("opacity", 0) 
                    .call(makeAnnotations);


                // Animate the annotation appearance
                annotationGroup
                    .transition()
                    .duration(1000)        
                    .delay(1500)          
                    .style("opacity", 1)
                    .ease(d3.easeBackOut);

            }

            // Chart 2: Cylinders vs Efficiency Scatter Plot
            function createChart2() {
       
              // Chart dimensions
              const margin = { top: 20, right: 30, bottom: 80, left: 70 };
              const width = 900 - margin.left - margin.right;
              const height = 500 - margin.bottom - margin.top;

              // Create SVG
              const svg = d3.select('#chart2')
                  .attr('width', width + margin.left + margin.right)
                  .attr('height', height + margin.top + margin.bottom);
              const g = svg.append('g')
                  .attr('transform', `translate(${margin.left},${margin.top})`);

              // Scales
              const xScale = d3.scaleLinear()
                  .domain(d3.extent(data, d => d.cylinders))
                  .range([0, width])
                  .nice();

              const yScale = d3.scaleLinear()
                  .domain([0, d3.max(data, d => Math.max(d.highwayMPG, d.cityMPG))])
                  .range([height, 0])
                  .nice();
              
              // Add grid lines
              g.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickSize(-height)
                    .tickFormat("")
                )
                .selectAll("line")
                .attr("class", "grid-line")
                .style("stroke-dasharray", ("3, 3"));

              g.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                )
                .selectAll("line")
                .attr("class", "grid-line")
                .style("stroke-dasharray", ("3, 3"));
                  
              // Add axes
              g.append("g")
                  .attr("transform", `translate(0,${height})`)
                  .attr("class", "axis")
                  .call(d3.axisBottom(xScale));

              g.append("g")
                  .attr("class", "axis")
                  .call(d3.axisLeft(yScale));

              // Add axis labels
              g.append("text")
                  .attr("class", "axis-label")
                  .attr("transform", `translate(${width/2}, ${height + 40})`)
                  .style("text-anchor", "middle")
                  .style("fill", rootStyles.getPropertyValue('--grey'))
                  .text("Engine Cylinders");

              g.append("text")
                  .attr("class", "axis-label")
                  .attr("transform", "rotate(-90)")
                  .attr("y", 0 - margin.left + 15)
                  .attr("x", 0 - (height / 2))
                  .style("text-anchor", "middle")
                  .style("fill", rootStyles.getPropertyValue('--grey'))
                  .text("Miles Per Gallon (MPG)");
                
              // Add highway MPG points
              g.selectAll(".highway-point")
                  .data(data)
                  .enter()
                  .append("circle")
                  .attr("class", "highway-point")
                  .attr("cx", d => xScale(d.cylinders))
                  .attr("cy", d => yScale(d.highwayMPG))
                  .attr("r", 5)
                  .attr("fill", rootStyles.getPropertyValue('--blue'))
                  .attr("opacity", 0.7)
                  .attr("stroke", "white")
                  .attr("stroke-width", 1);

              // Add city MPG points
              g.selectAll(".city-point")
                  .data(data)
                  .enter()
                  .append("circle")
                  .attr("class", "city-point")
                  .attr("cx", d => xScale(d.cylinders))
                  .attr("cy", d => yScale(d.cityMPG))
                  .attr("r", 5)
                  .attr("fill", rootStyles.getPropertyValue('--red'))
                  .attr("opacity", 0.7)
                  .attr("stroke", "white")
                  .attr("stroke-width", 1);
              
              // Create Tooltip
              const tooltip = d3.select("#tooltip");

              // Add interactions for highway points
              g.selectAll(".highway-point")
                  .on("mouseover", function(event, d) {
                      d3.select(this).transition().duration(200).attr("r", 7).attr("opacity", 1);
                      tooltip.style("opacity", 1)
                          .html(`<strong>${d.make}</strong><br/>
                                 Cylinders: ${d.cylinders}<br/>
                                 Highway MPG: ${d.highwayMPG}`)
                          .style("left", (event.pageX + 10) + "px")
                          .style("top", (event.pageY - 10) + "px");
                  })
                  .on("mouseout", function() {
                      d3.select(this).transition().duration(200).attr("r", 5).attr("opacity", 0.7);
                      tooltip.style("opacity", 0);
                  });

              // Add interactions for city points
              g.selectAll(".city-point")
                  .on("mouseover", function(event, d) {
                      d3.select(this).transition().duration(200).attr("r", 7).attr("opacity", 1);
                      tooltip.style("opacity", 1)
                          .html(`<strong>${d.make}</strong><br/>
                                 Cylinders: ${d.cylinders}<br/>
                                 City MPG: ${d.cityMPG}`)
                          .style("left", (event.pageX + 10) + "px")
                          .style("top", (event.pageY - 10) + "px");
                  })
                  .on("mouseout", function() {
                      d3.select(this).transition().duration(200).attr("r", 5).attr("opacity", 0.7);
                      tooltip.style("opacity", 0);
                  });

                // Create annotation
                const annotations = [
                    {
                        note: {
                            label: "Note: as number of cylinders increase, fuel efficiency decreases"
                        },
                        x: 280,
                        y: 300,
                        dx: 30,
                        dy: -100
                    }
                ]

                const makeAnnotations = d3.annotation()
                    .type(d3.annotationLabel)
                    .annotations(annotations);

                // Add annotation group to the chart with initial hidden state
                const annotationGroup = d3.select("#chart2")
                    .append("g")
                    .attr("class", "annotation-group")
                    .style("opacity", 0) 
                    .call(makeAnnotations);


                // Animate the annotation appearance
                annotationGroup
                    .transition()
                    .duration(1000)        
                    .delay(1500)          
                    .style("opacity", 1)
                    .ease(d3.easeBackOut);
            }

            function createChart3(){
                const brandData = {};
                data.forEach(row => {
                    const brand = row.make;
                    const highwayMPG = row.highwayMPG;
                    const cityMPG = row.cityMPG;
                    const combinedMPG = row.combinedMPG;
                    const fuel = row.fuel;

                    if (!brandData[brand]) {
                      brandData[brand] = {
                          brand: brand,
                          totalCombinedMPG: 0,
                          count: 0,
                          fuelTypes: {},
                          fuelTypesList: [],
                          cityMPGs: [],
                          highwayMPGs: []
                      };
                    }

                    brandData[brand].totalCombinedMPG += combinedMPG;
                    brandData[brand].count += 1;
                    brandData[brand].cityMPGs.push(cityMPG);
                    brandData[brand].highwayMPGs.push(highwayMPG);

                    if (!brandData[brand].fuelTypes[fuel]) {
                        brandData[brand].fuelTypes[fuel] = 0;
                        brandData[brand].fuelTypesList.push(fuel);
                    }

                    brandData[brand].fuelTypes[fuel]++;
                });

                // Calculate averages and determine predominant fuel type
                const processedData = Object.values(brandData).map(d => {
                    const avgCombinedMPG = d.totalCombinedMPG / d.count;
                    const avgCityMPG = d.cityMPGs.reduce((a, b) => a + b, 0) / d.cityMPGs.length;
                    const avgHighwayMPG = d.highwayMPGs.reduce((a, b) => a + b, 0) / d.highwayMPGs.length;

                    // Determine predominant fuel type
                    let predominantFuel = 'Mixed';
                    let maxCount = 0;
                    const fuelTypeCount = Object.keys(d.fuelTypes).length;

                    if (fuelTypeCount === 1) {
                        predominantFuel = Object.keys(d.fuelTypes)[0];
                    }
                    else {
                        for (const [fuel, count] of Object.entries(d.fuelTypes)) {
                            if (count > maxCount) {
                                maxCount = count;
                                predominantFuel = fuel;
                            }
                        }
                        if (fuelTypeCount > 1) predominantFuel = 'Mixed';
                    }

                    scaledAvgCombinedMPG = avgCombinedMPG * d.count;

                    return {
                        brand: d.brand,
                        avgCombinedMPG: avgCombinedMPG,
                        avgCityMPG: avgCityMPG,
                        avgHighwayMPG: avgHighwayMPG,
                        predominantFuel: predominantFuel,
                        modelCount: d.count,
                        scaledAvgCombinedMPG: scaledAvgCombinedMPG,
                        fuelTypes: d.fuelTypes,
                        fuelTypesList: d.fuelTypesList
                    };
                });

                // Color scheme for different fuel types
                const fuelColors = {
                    'Gasoline': rootStyles.getPropertyValue('--blue'),
                    'Diesel': rootStyles.getPropertyValue('--orange'),
                    'Electricity': rootStyles.getPropertyValue('--green'),
                    'Mixed': rootStyles.getPropertyValue('--pink')
                };
                    
                // Sort by combined MPG (descending)
                processedData.sort((a, b) => b.scaledAvgCombinedMPG - a.scaledAvgCombinedMPG);

                // Chart dimensions
                const margin = { top: 20, right: 80, bottom: 40, left: 120 };
                const width = 900 - margin.left - margin.right;
                const height = processedData.length * 25 + margin.top + margin.bottom;
                
                // Create SVG
                const svg = d3.select('#chart3')
                  .attr('width', width + margin.left + margin.right)
                  .attr('height', height + margin.top + margin.bottom);
                const g = svg.append('g')
                  .attr('transform', `translate(${margin.left},${margin.top})`);

                // Create scales
                const xScale = d3.scaleLinear()
                  .domain([0, d3.max(processedData, d => d.scaledAvgCombinedMPG) * 1.1])
                  .range([0, width]);

                const yScale = d3.scaleBand()
                  .domain(processedData.map(d => d.brand))
                  .range([0, height - margin.top - margin.bottom])
                  .padding(0.1);

                // Create tooltip
                const tooltip = d3.select("#tooltip");

                // Draw bars
                const bars = g.selectAll(".bar")
                  .data(processedData)
                  .enter().append("rect")
                  .attr("class", "bar")
                  .attr("x", 70)
                  .attr("y", d => yScale(d.brand))
                  .attr("width", 0)
                  .attr("height", yScale.bandwidth())
                  .attr("fill", d => fuelColors[d.predominantFuel] || fuelColors['Gasoline'])
                  .attr("rx", 4)
                  .attr("ry", 4);

                // Animate bars
                bars.transition()
                  .duration(1000)
                  .delay((d, i) => i * 50)
                  .attr("width", d => xScale(d.scaledAvgCombinedMPG));


                // Add value labels on bars
                const valueLabels = g.selectAll(".value-label")
                  .data(processedData)
                  .enter().append("text")
                  .attr("class", "value-label")
                  .attr("x", d => xScale(d.scaledAvgCombinedMPG) + 75)
                  .attr("y", d => yScale(d.brand) + yScale.bandwidth() / 2)
                  .attr("dy", "0.35em")
                  .text(d => d.scaledAvgCombinedMPG.toFixed(1))
                  .style("opacity", 0);

                // Animate value labels
                valueLabels.transition()
                  .duration(1000)
                  .delay((d, i) => i * 50 + 500)
                  .style("opacity", 1)
                  .attr("font-size", 12)
                  .attr("fill", rootStyles.getPropertyValue('--grey'));

                // Add brand labels
                g.selectAll(".bar-label")
                  .data(processedData)
                  .enter().append("text")
                  .attr("class", "bar-label")
                  .attr("x", 60)
                  .attr("y", d => yScale(d.brand) + yScale.bandwidth() / 2)
                  .attr("dy", "0.35em")
                  .style("text-anchor", "end")
                  .attr("fill", rootStyles.getPropertyValue('--grey'))
                  .text(d => d.brand);

                // Add hover effects
                bars.on("mouseover", function(event, d) {
                      d3.select(this).style("filter", "brightness(1.1)");
                      
                      // Create fuel type breakdown for mixed brands
                      let fuelTypeText = d.predominantFuel;
                      if (d.predominantFuel === 'Mixed') {
                          const fuelBreakdown = Object.entries(d.fuelTypes)
                              .map(([fuel, count]) => `${fuel} (${count})`)
                              .join(', ');
                          fuelTypeText = `Mixed - ${fuelBreakdown}`;
                      }
                      
                      tooltip.style("opacity", 1)
                          .html(`
                              <strong>${d.brand}</strong><br/>
                              Combined MPG: <strong>${d.avgCombinedMPG.toFixed(1)}</strong><br/>
                              City MPG: ${d.avgCityMPG.toFixed(1)}<br/>
                              Highway MPG: ${d.avgHighwayMPG.toFixed(1)}<br/>
                              Fuel Type: ${fuelTypeText}<br/>
                              Models: ${d.modelCount}
                          `)
                          .style("left", (event.pageX + 10) + "px")
                          .style("top", (event.pageY - 10) + "px");
                  })
                  .on("mouseout", function() {
                      d3.select(this).style("filter", "none");
                      tooltip.style("opacity", 0);
                  });

                // Add X axis
                g.append("g")
                  .attr("class", "axis")
                  .attr("transform", `translate(70,${height - margin.top - margin.bottom})`)
                  .call(d3.axisBottom(xScale).ticks(8));

                // Add X axis label
                g.append("text")
                  .attr("class", "axis-label")
                  .attr("transform", `translate(${(width / 2) + 70}, ${height - margin.top - margin.bottom + 35})`)
                  .style("text-anchor", "middle")
                  .attr("fill", rootStyles.getPropertyValue('--grey'))
                  .text("Scaled Average Combined MPG (Average MPG * Number of Models)");

                // Create annotation
                const annotations = [
                    {
                        note: {
                            label: "Note: Tesla's fuel efficiency comes from only one model",
                        },
                        x: 405,
                        y: 442,
                        dx: 30,
                        dy: 80,

                    }
                ]

                const makeAnnotations = d3.annotation()
                    .type(d3.annotationLabel)
                    .annotations(annotations);

                // Add annotation group to the chart with initial hidden state
                const annotationGroup = d3.select("#chart3")
                    .append("g")
                    .attr("class", "annotation-group")
                    .style("opacity", 0) 
                    .call(makeAnnotations);


                // Animate the annotation appearance
                annotationGroup
                    .transition()
                    .duration(1000)        
                    .delay(1500)          
                    .style("opacity", 1)
                    .ease(d3.easeBackOut);

            }
        </script>
    </body>
</html>
